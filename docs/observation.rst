Simulate the Observation
========================

To simulate an observation, you require a ``Target``, ``Instrument``,
and a date of observation ``date_obs``.

Running the simulation
----------------------

The ``observe`` function simulates the observation akin to the online
`ETC <https://jwst.etc.stsci.edu>`_ using the STScI's `pandeia <https://jwst-docs.stsci.edu/jwst-exposure-time-calculator-overview/jwst-etc-pandeia-engine-tutorial/pandeia-quickstart#gsc.tab=0>`_  python package.
Simulations with ``pandeia`` run locally on your machine.

.. code-block:: python

   >>> import jayrock

   >>> # Target and date_obs
   >>> target = jayrock.Target("Ophelia")
   >>> target.compute_ephemeris(cycle=6)
   >>> date_obs = target.get_date_obs(at="vmag_min")

   >>> # Instrument
   >>> inst = jayrock.Instrument("MIRI", "MRS")
   >>> inst.aperture = 'ch2'
   >>> inst.disperser = 'medium'
   >>> inst.detector.nexp = 4
   >>> inst.detector.ngroup = 10
   >>> inst.detector.nint = 1

   >>> # Run simulation
   >>> obs = jayrock.observe(target, inst, date_obs)
   INFO     [jayrock] Observing Target(name=Ophelia) with MIRI|mrs on 2028-03-30
   INFO     [jayrock] ch2|medium - ngroup=10|nint=1|nexp=4 - readout=fastr1
   INFO     [jayrock] SNR=766.0 at 9.41Î¼m in 1.9min
   WARNING  [jayrock] Observation warnings: {'cube_partial': 'There are 352 total
                      partially saturated pixels in the data cube.'}

Inspecting the Report
---------------------

The ``observe`` function returns an ``Observation`` object that contains the
same ``report`` as generated by the online ETC.

.. code-block:: python

   >>> obs.report.keys()
   dict_keys(['sub_reports', 'input', '1d', '2d', '3d', 'scalar', 'information', 'transform', 'warnings', 'web_report'])
   >>> obs.report['scalar']['sn']  # snr at reference wavelength
   765.9608182878744
   >>> wave, snr = obs.report['1d']['sn']  # snr over wavelength
   >>> wave[:5]
   [8.6909816  8.69261246 8.69424332 8.69587418 8.69750504]
   >>> snr[:5]
   [648.42203743 648.33386155 648.24524604 648.15622563 648.06695908]

Refer to the `pandeia documentation <https://jwst-docs.stsci.edu/jwst-exposure-time-calculator-overview/jwst-etc-pandeia-engine-tutorial/pandeia-reports#gsc.tab=0>`_ for details on the report structure and available information.

Some frequently used properties are directly accessible from the ``Observation`` object.

.. code-block:: python

   >>> obs.snr  # snr at reference wavelength
   >>> obs.texp  # exposure time in seconds
   >>> obs.plot_snr()  # plot snr over wavelength

.. dropdown:: Show SNR plot

    .. image:: gfx/ophelia_miri.png
         :class: only-light
         :align: center
         :width: 100%

    .. image:: gfx/ophelia_miri_dark.png
         :class: only-dark
         :align: center
         :width: 100%

Identifying saturation
^^^^^^^^^^^^^^^^^^^^^^

Some wavelengths in the example above are partially saturated. We see this in
multiple places: (1) the warning written to the console during the simulation
(identical to all warnings printed in the online ETC), (2) the orange colouring
and written "! SAT !" warnings in the SNR plot, and (3) when inspecting the
report:

.. code-block:: python

    >>> obs.partially_saturated # boolean array over wavelength. True where partially saturated
    array([False, False, False, ...,  True,  True,  True, ..., False, False])
    >>> obs.fully_saturated # boolean array over wavelength. True where fully saturated
    array([False, False, False, ...,  False,  False,  False, ..., False, False])
    >>> obs.n_partial_saturated # number of partially saturated pixels per wavelength
    [0, 0, 0, ..., 1, 1, 1, ..., 0, 0]
    >>> obs.is_saturated  # any wavelength fully or partially saturated?
    True

Observing in multiple configurations
------------------------------------

Each observation uses one specific instrument configuration. To simulate
observations of the same target with different configurations, simply use a loop.
This is especially useful for MIRI MRS, where each aperture and disperser
needs to be simulated separately.

.. code-block:: python

   observations = []
   for aperture in ['ch1', 'ch2', 'ch3', 'ch4']:
        for disperser in ['short', 'medium', 'long']:
            inst.aperture = aperture
            inst.disperser = disperser
            obs = jayrock.observe(target, inst, date_obs)
            observations.append(obs)

You can then plot the SNRs of all observations together:

.. code-block:: python

   jayrock.plot_snr(observations)  # plot SNRs of multiple observations together

.. dropdown:: Show SNR plot

    .. image:: gfx/ophelia_miri_all.png
         :class: only-light
         :align: center
         :width: 100%

    .. image:: gfx/ophelia_miri_all_dark.png
         :class: only-dark
         :align: center
         :width: 100%

Observing on multiple dates
---------------------------

You might want to compare the SNR obtained at two different epochs, e.g. to optimise
the exposure settings for the faintest epoch while ensuring that the observation does not
at saturate at the brightest one.

.. code-block:: python

   >>> observations = []
   >>> date_thermal_min, date_thermal_max = target.get_date_obs(at=["thermal_min", "thermal_max"])
   >>> for date_obs in [date_thermal_min, date_thermal_max]:
    ...     obs = jayrock.observe(target, inst, date_obs)
    ...     observations.append(obs)
   >>> jayrock.plot_snr(observations)  # plot SNRs of multiple observations together

.. dropdown:: Show SNR plot

    .. image:: gfx/ophelia_comparison.png
         :class: only-light
         :align: center
         :width: 100%

    .. image:: gfx/ophelia_comparison_dark.png
         :class: only-dark
         :align: center
         :width: 100%

    If more than one observation is done using the same aperture/disperser/filter combination, the text summarising the detector configuration at the bottom is colour-coded to match the respective SNR curve.
